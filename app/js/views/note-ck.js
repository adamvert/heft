define(["text!templates/note.html"],function(e){var t=new Showdown.converter,n=Backbone.View.extend({tagName:"a",className:"tile",template:_.template(e),events:{dblclick:function(){this.trigger("doubleclicked",this.model)}},initialize:function(){this.model.bind("change:style change:content",this.render,this);this.model.get("style")||this.model.setRandomStyle()},render:function(){var e=this.template(this.toJSON());this.$el.children(".note").length>0?this.$el.children(".note").replaceWith($(e)):this.$el.html(e);this.renderStyle();return this},hide:function(){this.$el.css("display","none")},show:function(){this.$el.css("display","")},renderStyle:function(){var e=this.$el.find(".note"),t=this.model.get("style"),n={},r=[],i=[];e.attr("style","");e.children().attr("style","");this.addOrRemoveSpans(e,t);var s=this;_.each(_.keys(t),function(o){if(o.substring(0,1)==="$")t[o]?r.push(s.styleHyphenFormat(o.substring(1))):i.push(s.styleHyphenFormat(o.substring(1)));else if(o.indexOf("__")!==-1){var u=o.split("__"),a=u[0].split("_"),f="";_.each(a,function(e){f+=e+" "});e.find(f).css(s.styleHyphenFormat(u[1]),_.isArray(t[o])?s.arrayToRGB(t[o]):t[o])}else n[o]=t[o]});n.backgroundColor=this.arrayToRGB(t.bgColor);n.color=this.arrayToRGB(t.fgColor);e.css(n);e.addClass(_.reduce(r,function(e,t){return e+t+" "},""));e.removeClass(_.reduce(i,function(e,t){return e+t+" "},""));e.height()>0&&!this.model.get("pageFitted")&&this.fitToPage()},arrayToRGB:function(e){return"rgb("+e[0]+","+e[1]+","+e[2]+")"},addOrRemoveSpans:function(e,t){var n=e.children("h1").first(),r,i;if(t.h1_span__color){i=n.html();r=$("<span></span>").html(i);n.html("").append(r)}else if(n.children("span").length>0){r=$("h1").children("span");i=r.html();n.html(i);r.remove()}},styleHyphenFormat:function(e){function t(e){return"-"+e.toLowerCase()}return e.replace(/[A-Z]/g,t)},fitToPage:function(){var e=this.$el.find(".note"),t=Number(this.model.get("style").fontSize.slice(0,-2)),n=Number(this.model.get("style").h1__fontSize.slice(0,-2)),r=Number(this.model.get("style").p__marginTop.slice(0,-2)),i=this.model.get("style").lineHeight,s=Number(this.model.get("style").padding.slice(0,-2)),o=this.outerHeight(e);console.log(e.css("font-size")+"::"+e.css("line-height")+"::"+o);while(o>e.height()&&t>24){console.log(e.css("font-size")+"::"+e.css("line-height")+"::"+o);o=0;t=Math.round(t*.9);n=Math.round(n*.8);r=Math.round(r*.9);s=Math.round(s*.8);e.css("font-size",t+"px");e.css("padding",s+"px");e.children("h1").css("font-size",n+"em");o=this.outerHeight(e)}console.log(e.css("font-size")+"::"+e.css("line-height")+"::"+o);var u=e.height()-o,a=u>0?[s,u/2,u-s][Math.round(Math.random()*2)]:Math.round(Math.random()*30);this.model.get("style").fontSize=t+"px";this.model.get("style").padding=a+"px "+s+"px "+s+"px";this.model.get("style").h1__fontSize=n+"em";this.model.get("style").p__marginTop=r+"px";this.model.set("pageFitted",!0);this.renderStyle()},outerHeight:function(e){var t=Number(e.css("padding").slice(0,-2))*2,n=0,r,i;e.children().each(function(){r=Number($(this).css("margin-top").slice(0,-2));i=Number($(this).css("margin-bottom").slice(0,-2));t+=$(this).height();t+=r>n?r:n;n=i});t+=n;return t},toJSON:function(){return{title:this.smarten(this.model.get("content").split("\n")[0].substr(0,30)),content:this.makeLinks(t.makeHtml("#"+this.smarten(this.model.get("content")))),modifyDate:this.model.getModifyDateAsString()}},makeLinks:function(e){return e.replace(/http.*/gi,'[<a href="$1" target="_blank">...</a>]')},smarten:function(e){e=e.replace(/(^|[-\u2014\s(\["])'/g,"$1‘");e=e.replace(/'/g,"’");e=e.replace(/(^|[-\u2014/\[(\u2018\s])"/g,"$1“");e=e.replace(/"/g,"”");e=e.replace(/--/g,"—");return e}});return n});