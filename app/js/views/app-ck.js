define(["models/note","collections/notes","views/note","stores/simplenote"],function(e,t,n,r){var i=Backbone.View.extend({el:$(".main"),events:{"click .page-buttons .randomise-button":function(){this.app.trigger("randomStyle")},"click .preview-buttons .edit-button":function(){this.trigger("randomStyle")},"click .preview-buttons .next-button":function(){this.trigger("selectNextNote")},"click .preview-buttons .prev-button":function(){this.trigger("selectPreviousNote")},"click .edit-buttons .ok-button":function(){this.trigger("saveNote")}},noteViews:{},pageWidth:480,pageHeight:690,portholeWidth:120,filter:"",initialize:function(){this.on("editNote",this.editNote,this);this.on("saveNote",this.saveNote,this);this.on("selectNextNote",this.selectNextNote,this);this.on("selectPreviousNote",this.selectPreviousNote,this)},affixButtons:function(e){var t=e.noteRecto.$el,n=t.children(".note"),r=n.css("background-color"),i=this.calculateContrastingColor(r);this.hideButtons();$(".preview-buttons").remove().appendTo(t).css("background-color",r).css("border-top","1px solid "+i).children("a").css("color",i);$(".preview-buttons").show()},toggleButtons:function(){this.buttonsAreVisible()?this.hideButtons():this.showButtons()},showButtons:function(){$(".preview-buttons").css("box-shadow","rgba(0, 0, 0, 0.5) 0 0 10px");$(".preview-buttons").css("bottom","0px")},hideButtons:function(){if(this.buttonsAreVisible()){$(".preview-buttons").bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){$(".preview-buttons").unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");$(".preview-buttons").css("box-shadow","")});$(".preview-buttons").css("bottom","-60px")}},buttonsAreVisible:function(){return $(".preview-buttons").css("bottom")=="0px"},render:function(){this.$el.css("display","none");_.each(this.app.collections.notes.models,function(e){this.getNoteView(e)||this.renderNote(e)},this);this.$el.css("display","")},renderNote:function(e){e.get("style")||e.setRandomStyle();var t=new n({model:e});this.noteViews[e.get("id")]=t;var r=this.$el.children(".tiles").children(".cf").detach();this.$el.children(".tiles").append(t.render().el).append(r);t.on("selected",function(e){this.selectNote(e)},this);this.selectedNote||this.selectNote(e)},getNoteView:function(e){return _.find(this.noteViews,function(t){return t.model===e},this)},filterNotes:function(e){if(this.filter===e)return;var t=new RegExp(e,"ig");this.filter=e;$(".notes").css("display","none");this.notes.models.reverse();_.each(this.notes.models,function(e){e.get("content").search(t)===-1?this.getNoteView(e).hide():this.getNoteView(e).show()},this);this.notes.models.reverse();$(".notes").css("display","")},toggleNote:function(e){e.get("isSelected")?this.selectNote(e):this.deselectNote(e)},selectNote:function(e){this.selectedNote&&this.deselectNote();this.selectedNote=e;var t=this,n=this.getNoteView(e),r=n.$el.children(".porthole").clone().removeClass("porthole").addClass("active-note-display").addClass("flip-face"),i=r.children(".note").css("background-color"),s=this.calculateContrastingColor(i);r.prependTo(".flip-holder");r.dblclick($.proxy(this.editNote,this));r.click({context:this},this.setRandomStyleAndReplace);$(".edit-pane").val(this.selectedNote.get("content"));n.$el.addClass("selected-note");$(".preview-buttons").detach().appendTo(r).css("background-color",i).css("border-top","1px solid "+s).children("a").css("color",s).end().show();window.setTimeout(function(){t.flipNote(n)},100)},selectNextNote:function(){if(!this.selectedNote)return;var e=this.app.notes.indexOf(this.selectedNote);typeof e!="undefined"&&e<this.app.notes.length-1&&this.selectNote(this.app.notes.models[e+1])},selectPreviousNote:function(){if(!this.selectedNote)return;var e=this.app.notes.indexOf(this.selectedNote);typeof e!="undefined"&&e>0&&this.selectNote(this.app.notes.models[e-1])},flipNote:function(e){e.$el.toggleClass("note-spinner")},setRandomStyleAndReplace:function(e){if($(e.target).is("i"))return;var t,n=e.data.context,r=n.getNoteView(n.selectedNote),i,s;n.selectedNote.setRandomStyle();n.flipNote(r);t=r.$el.children(".porthole").clone();i=t.children(".note").css("background-color"),s=n.calculateContrastingColor(i);$(".preview-buttons").detach().appendTo(n.$el).hide();$(this).replaceWith(t.removeClass("porthole").addClass("active-note-display").addClass("flip-face"));t.click({context:n},n.setRandomStyleAndReplace);$(".preview-buttons").detach().appendTo(t).css("background-color",i).css("border-top","1px solid "+s).children("a").css("color",s).end().show()},deselectNote:function(){var e=this.getNoteView(this.selectedNote);$(".preview-buttons").detach().appendTo(this.$el).hide();$(".active-note").children(".flip-holder").removeClass("flip-me");$(".active-note").children(".flip-holder").children(".active-note-display").remove();$(".edit-pane").val("");this.selectedNote.set("isSelected",!1);e.$el.removeClass("selected-note");this.selectedNote=null},editNote:function(){$(".flip-holder").toggleClass("flip-me")},saveNote:function(){var e=this.getNoteView(this.selectedNote);if($(".edit-pane").val()!==this.selectedNote.get("content")){this.selectedNote.isDirty=!0;this.selectedNote.set("content",$(".edit-pane").val())}this.selectedNote.set("pageFitted",!1);e.render();this.selectedNote.save();this.flipNote(e);$(".preview-buttons").detach().appendTo(this.$el).hide();$(".active-note-display").html(e.$el.children(".porthole").html());$(".preview-buttons").detach().appendTo(".active-note-display").show();$(".flip-holder").toggleClass("flip-me")},calculateContrastingColor:function(e){var t=_.map(e.slice(4,-1).split(","),function(e){return Number(e)}),n=_.reduce(t,function(e,t){return e+t},0)/3<128,r=n?255:0,i=_.map(t,function(e){return Math.round((e+3*r)/4)});return"rgb("+i[0]+","+i[1]+","+i[2]+")"},webkitRender:function(e){e.style.display="none";e.offsetHeight;e.style.display="block"}});return i});