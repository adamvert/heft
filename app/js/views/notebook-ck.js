define(["text!templates/notebook.html","views/note","views/page"],function(e,t,n){var r=Backbone.View.extend({el:$("#book-holder"),$el:this.el,template:_.template(e),isDragging:!1,isTurning:!1,isMouseDown:!1,lastDragEvent:0,mouseX:0,currentPage:undefined,currentPageRotation:0,initialPageRotation:"",isDoubleSpread:!1,pageWidth:480,pages:[],initialize:function(e){this.app=e.app;"ontouchstart"in window?this.initTouch():this.initMouse();Backbone.Mediator.sub("note:predestroy",function(e){this.removePage.apply(this,[e])},this);Backbone.Mediator.sub("note:randomisestyle",function(){this.getCurrentNoteView().model.setRandomStyle();Backbone.Mediator.pub("note:styleupdated",this.currentPage)},this);Backbone.Mediator.sub("notebook:mouselongclick",function(){var e=this.getCurrentNoteView();e&&e.showEditView.apply(e)},this)},render:function(){var e,t,n;this.$el.html(this.template());this.currentPage=this.createPage(this.model.currentNote);this.$currentPage=this.currentPage.$el;this.currentPage.$el.appendTo(this.$el.children(".book"));e=this.getAdjacentPages();t=e[0];n=e[1];t&&t.$el.remove().insertBefore(this.currentPage.$el).show();n&&n.$el.remove().insertBefore(this.currentPage.$el).show();return this},getCurrentNoteView:function(){return this.currentPage.noteRecto},getCurrentPageView:function(){return this.currentPage},removePage:function(e){this.pagePendingDestruction=_.find(this.pages,function(t){return t.getNote()==e});this.pages=_.reject(this.pages,function(e){return e==this.pagePendingDestruction});if(this.pagePendingDestruction==this.currentPage)if(this.isFirst())this.swipePage(!0);else{this.currentPage=this.getPrevPage();this.swipePage(!1)}},createPage:function(e){var r=new n(new t({model:e}));r.$el=$("<div></div>").addClass("page").addClass(e.cid);r.render();this.pages.push(r);return r},getNextPage:function(e){var t=e||this.currentPage,n=t.noteRecto.model,r=this.model.getNextNote(n),i;if(!r)return null;i=_.find(this.pages,function(e){return e.noteRecto.model==r||e.noteVerso&&e.noteVerso.model==r});i||(i=this.createPage(r));return i},getPrevPage:function(e){var t=e||this.currentPage,n=t.noteRecto.model,r=this.model.getPrevNote(n),i;if(!r)return null;i=_.find(this.pages,function(e){return e.noteRecto.model==r||e.noteVerso&&e.noteVerso.model==r});i||(i=this.createPage(r));return i},isLast:function(e){var t=e||this.currentPage,n=t.model;return this.model.isLastNote(n)},isFirst:function(e){var t=e||this.currentPage,n=t.model;return this.model.isFirstNote(n)},getAdjacentPages:function(e,t){var n=_.isArray(e)?e:this.currentPage,r=_.isBoolean(e)?e:_.isUndefined(t)?!0:t,i=r?this.getNextPage(n):this.getPrevPage(n),s=r?this.getPrevPage(n):this.getNextPage(n);return[i,s]},turnForward:function(){this.initialPageRotation=this.currentPageRotation=0;this.turnPage(!0)},turnBack:function(){this.initialPageRotation=this.currentPageRotation=-180;this.turnPage(!1)},turnPage:function(e){var t=this;this.initiatePageTurn(e);this.initiatePageSwipe(e);this.rotatePage(e?-180:180+this.currentPageRotation,function(){t.concludePageTurn(e)})},initiatePageSwipe:function(e){this.turningFwd=e;Backbone.Mediator.pub("notebook:pageturnstart")},swipePageIncremental:function(e,t){var n=this.currentPage.$el.css("-webkit-transition");this.currentPage.$el.css("-webkit-transition","");this.incrementalDiff=this.incrementalDiff?this.incrementalDiff+t:t;e?this.currentPage.$el.css("-webkit-transform","translateX("+Math.round(this.incrementalDiff*50)+"%)"):this.currentPage.$el.css("-webkit-transform","translateX("+Math.round(this.incrementalDiff*50)+"%)");this.currentPage.$el.css("-webkit-transition",n)},swipePage:function(e){var t=this;this.initiatePageSwipe(e);this.currentPage.$el.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){t.currentPage.$el.unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");t.concludePageSwipe(e)});this.currentPage.$el.toggleClass("offscreen")},concludeIncrementalPageSwipe:function(){var e=this.currentPage.$el.css("-webkit-transition"),t;this.incrementalDiff<0?this.currentPage.$el.css("-webkit-transform","translateX(-50%)"):this.currentPage.$el.css("-webkit-transform","translateX(0%)");this.incrementalDiff=0;this.currentPage.$el.toggleClass("offscreen");this.currentPage.$el.css("-webkit-transform"," ");this.concludePageSwipe(this.turningFwd)},concludePageSwipe:function(e){var t=this.getAdjacentPages(e),n=t[0],r=t[1],i,s;i=e?this.currentPage:r;i.getNote().model.set("stylable",!1);i.getNote().model.save();if(e){r&&r.$el.remove().appendTo("#page-store");this.currentPage=n;n=this.getNextPage();n.$el.remove().insertBefore(this.currentPage.$el)}else{n&&n.$el.remove().addClass("offscreen").insertAfter(this.currentPage.$el).show();s=this.getNextPage(i);s.$el.remove().appendTo("#page-store")}this.currentPage.$el.find("textarea").length>0&&this.currentPage.$el.find("textarea").focus();this.isTurning=!1;this.currentPageRotation=0;this.initialPageRotation="";if(this.pagePendingDestruction){this.pagePendingDestruction.$el.remove();this.pagePendingDestruction=null}Backbone.Mediator.pub("notebook:pageturnend");Backbone.Mediator.pub("notedeselected",i);Backbone.Mediator.pub("noteselected",this.currentPage)},initiatePageTurn:function(e){var t=this.getAdjacentPages(e),n=t[0],r=t[1];Backbone.Mediator.pub("notebook:pageturnstart");thi=!0;this.currentPage.sideCss("box-shadow","10px 0 5px rgba(0, 0, 0, 0.3)","recto");this.currentPage.sideCss("box-shadow","-10px 0 5px rgba(0, 0, 0, 0.3)","verso");if(e)this.currentPageRotation=this.initialPageRotation=0;else if(!this.isDoubleSpread){this.currentPageRotation=-91;this.initialPageRotation=-180}else this.currentPageRotation=this.initialPageRotation=-180;n&&n.$el.remove().insertBefore(this.currentPage.$el).show();r&&r.$el.remove().insertBefore(this.currentPage.$el).show()},concludePageTurn:function(e){var t=this.getAdjacentPages(e),n=t[0],r=t[1],i;this.currentPage.css("-webkit-transition","-webkit-transform 0.5s ease-in-out");this.currentPage.sideCss("box-shadow","");if(this.initialPageRotation===this.currentPageRotation)n&&n.length&&n.$el.remove().appendTo("#page-store");else{i=e?this.currentPage:r;i.getNote().model.set("stylable",!1);i.getNote().model.save();r&&r.$el.remove().appendTo("#page-store");n&&(e?this.currentPage.$el.remove().insertBefore(n.$el):n.$el.remove().insertAfter(this.currentPage.$el));e&&(this.currentPage=n);this.currentPage.$el.find("textarea").length>0&&this.currentPage.$el.find("textarea").focus()}this.isTurning=!1;this.currentPageRotation=0;this.initialPageRotation="";if(this.pagePendingDestruction){this.pagePendingDestruction.$el.remove();this.pagePendingDestruction=null}Backbone.Mediator.pub("notebook:pageturnend");Backbone.Mediator.pub("notedeselected",i);Backbone.Mediator.pub("noteselected",this.currentPage)},rotatePage:function(e,t){var n=this;if(e===0)t&&t.call();else{this.currentPageRotation=this.currentPageRotation+e;t&&this.currentPage.$el.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){n.currentPage.$el.unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");t.call()});this.currentPage.css("-webkit-transform","rotateY("+this.currentPageRotation+"deg)")}},initTouch:function(){var e=this;this.$el.off("touchstart");this.$el.off("mousedown");this.$el.on("touchstart",".recto",function(t){e.pointerStart(t)});this.$el.on("touchmove",".book",function(t){e.pointerMove(t)});this.$el.on("touchend",function(t){e.pointerEnd(t)})},initMouse:function(){var e=this;this.$el.off("touchstart");this.$el.off("mousedown");this.$el.on("mousedown",".recto",function(t){e.pointerStart(t)});this.$el.on("mousemove",".book",function(t){e.pointerMove(t)});this.$el.on("mouseup",function(t){e.pointerEnd(t)})},pointerStart:function(e){var t=this.analysePointerEvent(e),n=this;t.isTouch||(this.isMouseDown=!0);this.mouseX=t.xCoord;this.mouseY=t.yCoord;this.longClickTimerId=window.setTimeout(n.handleLongClickEvent,1e3);Backbone.Mediator.pub("notebook:mousedown")},pointerMove:function(e){if(this.isScrolling)return;var t=this.analysePointerEvent(e),n=Math.abs(t.xCoord-this.mouseX),r=Math.abs(t.yCoord-this.mouseY),i=.05;if(t.isTouch){if(r>i&&!this.isDragging){this.isScrolling=!0;this.endLongClickTimer();Backbone.Mediator.pub("notebook:mousescroll")}else if(n>i){e.preventDefault();this.continueSwipeEvent(t.xCoord);this.endLongClickTimer();Backbone.Mediator.pub("notebook:mouseswipe")}}else if(this.isMouseDown&&n>i){this.continueSwipeEvent(t.xCoord);this.endLongClickTimer();Backbone.Mediator.pub("notebook:mouseswipe")}},pointerEnd:function(e){if(this.isScrolling){this.isScrolling=!1;return}this.endLongClickTimer();var t=this.analysePointerEvent(e),n=Math.abs(t.xCoord-this.mouseX),r=.05;t.isTouch||(this.isMouseDown=!1);if(this.isDragging)this.endSwipeEvent(t.xCoord);else if(n<r){this.handleClickEvent();Backbone.Mediator.pub("notebook:mouseup")}},analysePointerEvent:function(e){var t={};if(e.touches||e.changedTouches){t.isTouch=!0;var n=e.touches[0]||e.changedTouches[0];t.xCoord=this.normaliseXCoord(n.pageX);t.yCoord=this.normaliseYCoord(n.pageY)}else{t.isTouch=!1;t.xCoord=this.normaliseXCoord(e.pageX);t.yCoord=this.normaliseYCoord(e.pageY)}return t},normaliseXCoord:function(e){var t=this.currentPage.$el.parents(".book").offset(),n=this.currentPage.$el.parents(".book").width(),r=(e-(t.left+n/2))/(n/2);return r},normaliseYCoord:function(e){var t=this.currentPage.$el.parents(".book").offset(),n=this.currentPage.$el.parents(".book").height(),r=(e-(t.top+n/2))/(n/2);return r},handleClickEvent:function(e){if(!this.isTurning)if(this.mouseX<.2&&!this.isFirst()){this.currentPage=this.getPrevPage();this.swipePage(!1)}else this.mouseX>.8?this.swipePage(!0):Backbone.Mediator.pub("notebook:mouseclick")},endLongClickTimer:function(){if(this.longClickTimerId){window.clearTimeout(this.longClickTimerId);this.longClickTimerId=undefined}},handleLongClickEvent:function(){this.isMouseDown=!1;Backbone.Mediator.pub("notebook:mouselongclick")},continueSwipeEvent:function(e){var t;if(!this.isDragging){t=e<this.mouseX;if(!t){if(this.isFirst())return;this.currentPage=this.getPrevPage()}else if(this.isLast())return;this.isDragging=!0;this.initiatePageSwipe(t)}var n=e-this.mouseX;this.swipePageIncremental(e<this.mouseX,n);this.mouseX=e;this.lastDragEvent=Date.now()},endSwipeEvent:function(e){this.concludeIncrementalPageSwipe(e<this.mouseX);this.isDragging=!1}});return r});